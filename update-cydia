#/bin/sh

PKGDATE=`date +%s`
ZIPDATE=`date +%Y-%m-%d`

if [ "${RELEASE}" == "YES" ]; then
   FNAME=RetroArch
else
   FNAME=RetroArch_Nightly
fi

mkdir -p $BASEDIR/www/repo/cydia/

ls $BASEDIR/www/nightly/apple/ios/${ZIPDATE}_RetroArch.zip  -la


if [ ! -f $BASEDIR/www/nightly/apple/ios/${ZIPDATE}_RetroArch.zip -o ! -f $BASEDIR/www/nightly/apple/ios9/${ZIPDATE}_RetroArch9.zip ]; then
   echo nothing to do here
   exit
else
   echo "packaging"
fi

mkdir $BASEDIR/.cydia
cd $BASEDIR/.cydia

rm -rfv ${FNAME}
rm -rfv ${FNAME}.deb
rm *.zip

mkdir ${FNAME}
mkdir -p ${FNAME}/Applications
mkdir -p ${FNAME}/DEBIAN

cd ${FNAME}/Applications
cp $BASEDIR/www/nightly/apple/ios/${ZIPDATE}_RetroArch.zip .
unzip ${ZIPDATE}_RetroArch.zip
rm ${ZIPDATE}_RetroArch.zip
cd ..
cd DEBIAN

cat << EOF > control
Package: com.libretro.RetroArch
Name: RetroArch
Version: ${VERSION}.${PKGDATE}
Architecture: iphoneos-arm
Description: RetroArch Nightlies
Homepage: http://www.libretro.com
Depiction: http://buildbot.libretro.com/repo/cydia/retroarch.png
Maintainer: Radius
Author: Twinaphex
Sponsor:
Section: Games
Icon: http://buildbot.libretro.com/repo/cydia/retroarch-icon.png


EOF


mkdir $BASEDIR/.cydia
cd $BASEDIR/.cydia

rm -rfv ${FNAME}_iOS9
rm -rfv ${FNAME}_iOS9.deb
rm *.zip

mkdir ${FNAME}_iOS9
mkdir -p ${FNAME}_iOS9/Applications
mkdir -p ${FNAME}_iOS9/DEBIAN

cd ${FNAME}_iOS9/Applications
cp $BASEDIR/www/nightly/apple/ios9/${ZIPDATE}_RetroArch_iOS9.zip .
unzip ${ZIPDATE}_RetroArch_iOS9.zip
rm ${ZIPDATE}_RetroArch_iOS9.zip
mv *.app RetroArch.app
cd ..
cd DEBIAN

cat << EOF > control
Package: com.libretro.${FNAME}_iOS9
Name: RetroArch (iOS 9)
Version: ${VERSION}.${PKGDATE}
Architecture: iphoneos-arm
Description: RetroArch Nightlies for iOS9
Homepage: http://www.libretro.com
Depiction: http://buildbot.libretro.com/repo/cydia/retroarch.png
Maintainer: Radius
Author: Twinaphex
Sponsor:
Section: Games
Icon: http://buildbot.libretro.com/repo/cydia/retroarch-icon.png


EOF

cd
cd $BASEDIR/.cydia

dpkg-deb -Zgzip -b ${FNAME}
dpkg-deb -Zgzip -b ${FNAME}_iOS9

cp -rfv ${FNAME}.deb $BASEDIR/www/nightly/apple/ios/${ZIPDATE}_RetroArch.deb
cp -rfv ${FNAME}.deb $BASEDIR/www/repo/cydia/${FNAME}.deb
cp -rfv ${FNAME}_iOS9.deb $BASEDIR/www/nightly/apple/ios9/${ZIPDATE}_RetroArch_iOS9.deb
cp -rfv ${FNAME}_iOS9.deb $BASEDIR/www/repo/cydia/${FNAME}_iOS9.deb

cd $BASEDIR/www/repo/cydia/
rm Packages.bz2
$BASEDIR/tools/cydia/dpkg-scanpackages -m . /dev/null >Packages
bzip2 Packages

cat << EOF > Release
Origin: LibRetro Cydia Repository
Label: libretro
Suite: nightly
Version: 1.0
Codename: vaporeon
Architectures: iphoneos-arm
Components: main
Description: LibRetro Cydia Repository

EOF

